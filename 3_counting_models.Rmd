---
title: "NYC Shootings and Arrests - Counting Models"
author: "Sebastiano Quintavale - 878500"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        theme: cerulean
        highlight: tango
---

```{r echo=FALSE, include=FALSE}

# 1. RMardown styling
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 8)

# 2. Project environment setup
source("src/init.R")

```

```{r}

# Load data
crimes <- read.csv(PATHS$NycMonthCrimes)

# Add discrete version for Month and Year
prepare_out <- prepare_crimes(crimes_df=crimes)

crimes      <- prepare_out$df
CRIME_NAMES <- prepare_out$crime_names

rm(prepare_out)

# Split Train and Test
split <- train_test_split_by_year(df_ = crimes, year_test = YEAR_TEST)
crimes <- split$train
crimes_test <- split$test
rm(split)

split_out <- split_statenisland(crimes=crimes, crimes_test=crimes_test)

crimes         <- split_out$crimes
crimes_test    <- split_out$crimes_test
si_crimes      <- split_out$si_crimes
si_crimes_test <- split_out$si_crimes_test

rm(split_out)



crimes <- prepare_outliers(crimes)

```

## Poisson Model

### Seasonal model

```{r}

# Add constrast
contrasts(crimes     $MonthName) <- contr.sum(12)
contrasts(crimes_test$MonthName) <- contr.sum(12)

pois_models <- list()

tapply(crimes$Shootings, crimes$Borough, mean)
tapply(crimes$Shootings, crimes$Borough, var)
```

Comment on variability

```{r}
plot_prediction <- function(model, name, train=TRUE) {

    if(train) {
        df_ <- crimes
    } else {
        df_ <- crimes_test
    }

    invisible(
    plot_model_predictions_per_level_over_time(
        model = model,
        df_ =df_,
        y = "Shootings",
        levels = "Borough",
        title = paste("Shootings per Borough Prediction -", name, "-", ifelse(train, "Training", "Test"), "set"),
        ylab = "Shootings incidents",
        level = LEVEL,
        ticks = ifelse(train, 12, 5),
        lwd = 0.35,
        lwd_observations = 0.35,
        colors = unlist(PALETTE$boroughs),
        grid_rows = 2,
        glmnet_predictors = SHRINKAGE_PREDICTORS
    )
    )

}
```

```{r}

pois_models$seasonality <- glm(
    Shootings ~ Borough + MonthName,
    data = crimes,
    family = "poisson"
)


glm_diagnostic(
    model = pois_models$seasonality, 
    df_ = crimes, 
    gvif = FALSE,
    residuals = TRUE,
    overdispersion = FALSE
)

plot_prediction(pois_models$seasonality, "Seasonal")
plot_prediction(pois_models$seasonality, "Seasonal", train=FALSE)

```

More narrow CI even if we know overdispersion.

### Trended model

```{r}

pois_models$trended <- glm(
    Shootings ~ Borough + MonthName + T,
    data = crimes,
    family = poisson
)

glm_diagnostic(
    model=pois_models$trended, 
    df_=crimes,
    gvif=TRUE, overdispersion=FALSE
)

pois_models$trended <- NULL
```

Residuals not satisfactory for T

```{r}

pois_models$trended2 <- glm(
    Shootings ~ Borough + MonthName + poly(T, 3),
    data = crimes,
    family = poisson
)

glm_diagnostic(
    model=pois_models$trended2, 
    df_=crimes,
    gvif=FALSE, 
    overdispersion=FALSE
)


plot_prediction(pois_models$trended2, "Trended")
plot_prediction(pois_models$trended2, "Trended", train=FALSE)
```

```{r}
# Good for short-term prediction. Compare with others

linear_trended <- lm(
    Shootings ~ T + I(T^2) + I(T^3) + SinT + CosT + Borough,
    data = crimes
)

# First term test

stats_out <- data.frame(
    "tmp"  = c(1, 2)
)
first_test_epoch <- crimes_test$T[1]

for(MONTHS in 1:3) {

    short_term_test <- crimes_test[
        crimes_test$T >= first_test_epoch &
        crimes_test$T <= first_test_epoch + MONTHS,
    ]

    s_out <- stats_to_table(
        stats = get_models_prediction_stats(
            models = list(
                Linear  = linear_trended,
                Poisson = pois_models$trended2
            ),
            df_ = short_term_test,
            y = "Shootings"
    ))[, -c(1:4)]

    colnames(s_out) <- c(paste0("MSE(", MONTHS, ")"), paste0("AvgSE(", MONTHS, ")"))

    stats_out <- cbind(stats_out, s_out)

}

stats_out$tmp <- NULL

stats_out


rm(list = c(
    "linear_trended", "stats_out", "first_test_epoch", "s_out", "MONTHS"
))

```
### Total Arrests model
```{r}
pois_models$totarrests <- glm(
    Shootings ~ Borough + TotArrests + I(TotArrests^2),
    data = crimes, family = "poisson"
)

glm_diagnostic(
    pois_models$totarrests, df_=crimes,
    gvif=FALSE, overdispersion = FALSE
)

plot_prediction(pois_models$totarrests, "Total Arrests")
plot_prediction(pois_models$totarrests, "Total Arrests", train=FALSE)

```

It is able to catch a trend nel train, man on nel test managgia.

### Total Arrests and time

```{r}

head(crimes)

pois_models$totarrests_t <- glm(
    Shootings ~ Borough  + SinT + CosT + TotArrests + I(TotArrests^2),
    data = crimes, family = "poisson"
)

glm_diagnostic(
    pois_models$totarrests_t, df_=crimes,
    gvif=FALSE, overdispersion = FALSE
)

plot_prediction(pois_models$totarrests_t, "Total Arrests and Time")
plot_prediction(pois_models$totarrests_t, "Total Arrests and Time", train=FALSE)


stats_to_table(get_models_prediction_stats(
    models = list(
        TotArrests     = pois_models$totarrests,
        Time           = pois_models$trended2,
        TotArrestsTime = pois_models$totarrests_t
    ),
    df_ = crimes,
    y = "Shootings"
))[, c(3, 4)]
```




### Shrinkage for crimes across boroughs

```{r}

SHRINKAGE_PREDICTORS <- c(CRIME_NAMES, "T", "MonthName")
COL = "(1se, alpha=1)"

out_cols <- list()

for(borough in levels(crimes$Borough)) {

    print(paste("Borough crimes Shrinkage: ", borough))
    out <- shrinkage_grid_search(
        df_ = crimes[
            crimes$Borough == borough, 
            c(SHRINKAGE_PREDICTORS, "Shootings")
        ], 
        y="Shootings", 
        alphas=ALPHA_GLMNET
    )

    out_cols[[borough]] <- out[, c(COL)]


}

out_df <- round(do.call(rbind, out_cols), 3)
colnames(out_df) <- rownames(out)

out_df <- t(zero_to_point(out_df))

knit_table(out_df)

rm(out_df, out, COL, out_cols)
```

### Shrinkage model


```{r}

SHRINKAGE_PREDICTORS <- c(SHRINKAGE_PREDICTORS, "Borough")

zero_to_point(round(
shrinkage_grid_search(
    df_ = crimes[, c(SHRINKAGE_PREDICTORS, "Shootings")], 
    y="Shootings", 
    alphas=ALPHA_GLMNET
), 3)
)

```

```{r}
pois_models$lasso <- shrinkage_selection(
    df_ = crimes[, c(SHRINKAGE_PREDICTORS, "Shootings")],
    y = "Shootings",
    type = "1se",
    alpha = 1,
    title = paste("Lasso selection for NYC"),
    family="poisson"
)

```

```{r}

plot_prediction(pois_models$lasso, "Lasso Shrinkage")
plot_prediction(pois_models$lasso, "Lasso Shrinkage", train=FALSE)

```

### Stepwise model

```{r}

pois_models$stepwise <- step(
    glm(Shootings ~ 1, data=crimes[, c("Shootings", SHRINKAGE_PREDICTORS)], family="poisson"),
    scope = list(
        lower = glm(Shootings ~ 1, data=crimes[, c("Shootings", SHRINKAGE_PREDICTORS)], family="poisson"), 
        upper = glm(Shootings ~ ., data=crimes[, c("Shootings", SHRINKAGE_PREDICTORS)], family="poisson")
    ),
    direction = "both",
    k = log(nrow(crimes))
)

summary(pois_models$stepwise)

```




### Crimes model
```{r}
pois_models$crimes <- glm(
    Shootings ~ Borough + DrugRelated + Burglary + Murder +
        SinT + CosT,
    data = crimes, family = "poisson"
)

glm_diagnostic(
    pois_models$crimes, df_=crimes,
    gvif=TRUE, overdispersion = FALSE
)

plot_prediction(pois_models$crimes, "Crimes")
plot_prediction(pois_models$crimes, "Crimes")

```

### Model comparison



```{r}

pois_models$mean         <- glm(Shootings ~ 1,       data=crimes, family = "poisson")
pois_models$borough_mean <- glm(Shootings ~ Borough, data=crimes, family = "poisson")
```

```{r}

models_stats <- get_models_prediction_stats(
    models = pois_models,
    df_ = crimes_test,
    y = "Shootings",
    glmnet_predictors = SHRINKAGE_PREDICTORS
)

out_table <- stats_to_table(models_stats)[, -c(1, 2)]
out_table <- out_table[order(out_table$MSE), ]

knit_table(out_table)

```

## Comparison with other Counting Models

```{r}
model.pois <- glm(
    Shootings ~ Borough + SinT + CosT +
        DrugRelated + Murder + Burglary,
    data = crimes, family = "poisson"
)

```

### Quasi-poisson

```{r}
model.quasipois <- glm(
    Shootings ~ Borough + SinT + CosT +
        DrugRelated + Murder + Burglary,
    data = crimes, family = "quasipoisson"
)

summary(model.pois)
summary(model.quasipois)

(summary(model.quasipois))$dispersion
```

```{r}
crimes_ex <- data.frame(
    Month       = "Jan",
    T           = 128,
    SinT        = sin(2 * pi * 128 / 12),
    CosT        = cos(2 * pi * 128 / 12),
    Borough     = "Bronx",
    Murder      = 20,
    Burglary    = 50,
    DrugRelated = seq(1000, 10000, 1000)
)

{
pois_pred <- generate_predictions_with_ci(
    model = model.pois,
    newdata=crimes_ex,
    "Shootings", 
    response = "response",
    level = LEVEL
)

colnames(pois_pred)[colnames(pois_pred) == "Shootings"] <- "ShootingsPoisPred"
pois_pred$PoisPredSE <- pois_pred$Upper - pois_pred$ShootingsPoisPred

pois_pred$Lower <- NULL; pois_pred$Upper <- NULL
}

{
quasipois_pred <- generate_predictions_with_ci(
    model = model.quasipois,
    newdata=crimes_ex,
    "Shootings", 
    response = "response",
    level = LEVEL
)
colnames(quasipois_pred)[colnames(quasipois_pred) == "Shootings"] <- "ShootingsQuasipoisPred"
quasipois_pred$QuasipoisPredSE <- quasipois_pred$Upper - quasipois_pred$ShootingsQuasipoisPred
quasipois_pred$Lower <- NULL; quasipois_pred$Upper <- NULL
}

cbind(
    pois_pred     [, c("DrugRelated", "ShootingsPoisPred", "PoisPredSE")], 
    quasipois_pred[, c("ShootingsQuasipoisPred", "QuasipoisPredSE")]
)


rm(pois_pred, quasipois_pred, crimes_ex)
```


```{r}

plot_prediction(model.quasipois, "Quasi-Poisson")
plot_prediction(model.quasipois, "Quasi-Poisson", train=FALSE)
```

### Negative Binomial

```{r}

model.nb <- glm.nb(
    Shootings ~ Borough + SinT + CosT +
    DrugRelated + Murder + Burglary,
    data = crimes
)

summary(model.nb)

coef_comp <- data.frame(rbind(coef(model.pois), coef(model.nb)))
rownames(coef_comp) <- c("Poisson", "NegBin")

colnames(coef_comp)[1] = "Intercept"
colnames(coef_comp)[colnames(coef_comp) == "I.TotArrests.2."   ] = "TotArrests^2"

coef_comp

stats_to_table(get_models_prediction_stats(
    models = list(
        Poisson          = model.pois,
        NegBin = model.nb
    ),
    df_ = crimes,
    y = "Shootings"
))[, c(3, 4)]


```

```{r}
plot_prediction(model.nb, "Negative Binomial")
plot_prediction(model.nb, "Negative Binomial", train=FALSE)
```

### GAM

```{r}
model.gam_pois <- gam(
    Shootings ~ Borough + CosT + SinT + 
        s(DrugRelated) + s(Murder) + s(Burglary),
    data = crimes,
    family = poisson
)

summary(model.gam_pois)
```

```{r}
plot(model.gam_pois, shade = TRUE)
```

```{r}
plot_prediction(model.gam_pois, "GAM Poisson")
plot_prediction(model.gam_pois, "GAM Poisson", train=FALSE)
```


```{r}

model.gam_nb <- gam(
    Shootings ~ Borough + CosT + SinT + 
        s(DrugRelated) + s(Murder) + s(Burglary),
    data = crimes,
    family = nb
)


summary(model.gam_nb)

plot(model.gam_nb, shade = TRUE)

```

```{r}
plot_prediction(model.gam_nb, "GAM Negative Binomial")
plot_prediction(model.gam_nb, "GAM Negative Binomial", train=FALSE)
```

### Comparison


```{r}

models_stats <- get_models_prediction_stats(
    models = list(
        Pois    = model.pois,
        QPois   = model.quasipois,
        NegBin  = model.nb,
        GAMPois = model.gam_pois,
        GAMNb   = model.gam_nb
    ),
    df_ = crimes_test,
    y = "Shootings",
    glmnet_predictors = SHRINKAGE_PREDICTORS
)
out_table <- stats_to_table(models_stats)[, -c(1, 2)]
out_table

```



