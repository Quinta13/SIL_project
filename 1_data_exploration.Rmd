---
title: "NYC Shootings and Arrests - Data exploration"
author: "Sebastiano Quintavale - 878500"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        theme: cerulean
        highlight: tango
---

## 1. Introduction

This notebook is intended to ...

```{r echo=FALSE, include=FALSE}

# 1. RMardown styling
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(fig.width=9, fig.height=7)

# 2. Project environment setup
source("src/init.R")

```


### 1.1. Data preparation

Load the data and prepare it for the analysis.
```{r}

# Load data
crimes <- read.csv(PATHS$NycMonthCrimes)

```

The dataset has `r nrow(crimes)` rows and `r ncol(crimes)` columns.

Prepare dataset
- shift columns (start by February)
- add MonthName
- add T


```{r}

# Add discrete version for Month and Year
prepare_out <- prepare_crimes(crimes_df=crimes, use_families=FALSE)
crimes      <- prepare_out$df

rm(prepare_out)
```


View some rows and summary of the dataset.

```{r}

summary(crimes)
head(crimes, 25)

```

Brief comment on the type of the data.

### Train and Test split

We split train and test across years. Explain CV setup. Cannot apply cross validation for time dependence.
We only look at the train for exploration to simulate unseen data.
The dataset covers r`length(unique(crimes$Year))` years, we use the last r`length(YEAR_TEST)` for the test: r`YEAR_TEST`.

```{r}

# Split Train and Test
split <- train_test_split_by_year(
    df_=crimes, 
    year_test=YEAR_TEST
)

crimes      <- split$train
crimes_test <- split$test

rm(split)

```

Thus we have `r nrow(crimes)` for tran and `r nrow(crimes_test)` for test. 

## Visualizations

We start with brief visualization of the data to see if there are patterns in time and in the relationship between crimes and shootings.

### Time series

We start by plotting the time series of the crimes and shootings over the years.

```{r}

plot_multiple_ts(
    df_ts = ts_crimes_reshape(
        df_ = aggregate(
            . ~ Year + MonthName,
            data = crimes[, c("Year", "MonthName", CRIME_NAMES, "Shootings")], # Remove Borough, Month, TotArrests
            FUN = sum
        )
    ),
    group  = "CrimeType",
    xlab   = "Year",
    ylab   = "Incidents",
    title  = "Criminality in NYC - 2006 to 2021 ",
    lwd    = 0.7,
    ticks  = 7,
    colors = PALETTE$crimes,
    legend.size = 15
)

```

Good for overview but better inspect each in deatail.
Different scale and trend.

We plot each individual and visualize the time series for each borough.

```{r fig.width=16, fig.height=12}

BOROUGH_LEGEND <- extract_legend(

    plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
            crime_type = "Shootings"
        ),
        group  = "Borough",
        xlab = "Year",
        ylab   = "Arrests",
        legend.direction = "horizontal",
        legend.size = 13,
        colors=unlist(PALETTE$boroughs)
    )

)

plot_in_grid <- function(plot_list, ncol = 1, title = "", title.size=15, height = 0.4) {

    to_plot <- c(plot_list, list(BOROUGH_LEGEND))

    nplots <- length(plot_list)
    nrow <- ceiling(nplots / ncol)

    # Create the layout matrix
    layout_matrix <- matrix(seq(1, nrow * ncol), nrow = nrow, ncol = ncol, byrow = TRUE)
    layout_matrix <- rbind(layout_matrix, rep(max(layout_matrix, na.rm = TRUE) + 1, ncol))


    return(grid.arrange(
        grobs = to_plot,
        ncol = ncol,
        top = textGrob(
            title, 
            gp = gpar(fontsize = title.size, fontface = "bold")),
            layout_matrix = layout_matrix,
            heights = c(rep(1, nrow), height)  # Adjust the relative height for the legend row
    ))

}
```

```{r}

ts_plots <- list()

for (i in 1:length(CRIME_NAMES)) {

    crime_name <- CRIME_NAMES[i]

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        ylab   = ifelse((i-1) %% 4 == 0, "Arrests", ""),
        group  = "Borough",
        title  = paste(crime_name),
        lwd    = 0.5,
        colors = unlist(PALETTE$boroughs),
        ticks  = 3,
        legend = FALSE,
        title_size = 11
    )

}


plot_in_grid(
    plot_list = ts_plots,
    ncol = 4,
    title = "Crimes in NYC - 2006 to 2021"
)

rm(ts_plots)

```

Some comments patterns of different patterns and variability.

Let's better see the number compared with the shootings.
```{r}

ts_plots <- list()

for (crime_name in c("TotArrests", "Shootings")) {

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        group  = "Borough",
        xlab   = "Year",
        ylab   = ifelse(crime_name=="TotArrests", "Total Arrests", "Shootings Incidents"),
        title  = paste(crime_name),
        lwd    = 0.6,
        colors = unlist(PALETTE$boroughs),
        ticks  = 5,
        legend = FALSE
    )

}

plot_in_grid(
    plot_list = ts_plots,
    ncol = 2,
    title = "Arrests and Shootings in NYC - 2006 to 2021",
    height = 0.1,
    title.size = 20
)

rm(ts_plots)

```

Trend in TotArrests

Different comparison between arrests and shootings in terms of effect in boroughs.


### Scatterplots

See scatterplots of time variabiles. Year and Month.
```{r}

BOROUGH_LEGEND <- extract_legend(

    levels_scatterplot(
        df_     = crimes,
        x       = "Year",
        y       = "Shootings",
        levels  = "Borough",
        legend.direction = "horizontal",
        legend.size      = 13,
        colors = unlist(PALETTE$boroughs)
    )

)

scatterplots <- list()

# Plots
for (time in c("Year", "Month")) {
    scatterplots[[time]] <- levels_scatterplot(
        df_     = crimes,
        x       = time,
        y       = "Shootings",
        levels  = "Borough",
        title   = paste("Shootings by", time),
        title_size = 12,
        jitter_ = TRUE,
        ticks   = ifelse(time=="Month", 12, 5),
        shape   = 19,
        size    = 1,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE,
        ylab    = ifelse(time=="Year", "Shootings incidents", "")
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 2,
    title = "Shootings in NYC over time",
    title.size = 20,
    height = 0.1
)

rm(scatterplots)

```

Trend in the year with drop in 2020.
Seasonality with higher shootings in summer.

```{r}

scatterplots <- list()

# Plots
for (i in 1:length(CRIME_NAMES)) {

    crime <- CRIME_NAMES[i]

    scatterplots[[crime]] <- levels_scatterplot(
        df_     = crimes,
        x       = crime,
        y       = "Shootings",
        ylab    = ifelse((i-1) %% 4 == 0, "Shootings", ""),
        levels  = "Borough",
        title   = paste(crime),
        title_size = 9,
        jitter_ = TRUE,
        ticks   = 3,
        shape   = 20,
        size    = .05,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 4,
    title = "Crimes impact on shootings in NYC - 2006 to 2023"
)

rm(scatterplots)

```

Better inspect TotArrests

```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "TotArrests",
    y       = "Shootings",
    xlab    = "Total Arrests",
    ylab    = "Shootings Incidents",
    levels  = "Borough",
    title   = "Total Arrests impact on  Shootings in NYC - 2016 to 2023",
    title_size = 14,
    jitter_ = TRUE,
    ticks   = 3,
    shape   = 19,
    size    = 1.5,
    colors  = unlist(PALETTE$boroughs)
)


```

Remarks:
- StatenInsland very few crimes and shootings
- In general Bronx and Brooklyn tends to behave similar, and Queens and Manhattan tends to behave similar.
- There's a decrease to 2020 and then raise
- There seasonal effect at different scales
- Most linear evidence: Assaults, Murder, Robbery
- Possible Bi-cluster for larceny
- Marijuana sell possession it's interesting but has initial outliers.
- Quadratic effect for SubstancePossession, WeaponPossesion and TotArrests

## TODO Find name to this sections

### StatenInsland

Borough few criminalty treated differently from the others

```{r}

split_out <- split_statenisland(crimes=crimes, crimes_test=crimes_test)

crimes         <- split_out$crimes
crimes_test    <- split_out$crimes_test
si_crimes      <- split_out$si_crimes
si_crimes_test <- split_out$si_crimes_test

rm(split_out)

```


See info about Crimes

```{r}
summary(si_crimes)
```


```{r}

df_group_stats(si_crimes, "Year", "Shootings")

knit_table((df_group_stats(si_crimes, "Year", "Shootings")))
```

Month 
```{r}
knit_table(df_group_stats(si_crimes, "MonthName", "Shootings"))
```

Very few variation


### Outliers

Outliers substitution

```{r}
plot_multiple_ts(
    df_ts = ts_borough_reshape(
        df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
        crime_type = "Shootings"
    ),
    group = "Borough",
    xlab = "Year",
    ylab = "Incidents",
    title = paste("Shootings in NYC"),
    lwd = 0.7,
    colors = unlist(PALETTE$boroughs)
)
```

Particulary problematic with picks.

Use tso - expalin

Let's see if they can be detected

```{r}

AAAA

palette_outlier <- PALETTE$outliers

for(y in c("Shootings", CRIME_NAMES)) {

    outliers_plots <- list()

    for(borough in levels(crimes$Borough)) {

        palette_outlier$ts <- PALETTE$boroughs[[borough]]

        outliers_out <- outliers_diagnostic(
            df_ = crimes[crimes$Borough == borough,],
            y = y,
            colors = palette_outlier,
            title = borough,
            ylab = "Shootings incidents"
        )

        outliers_plots[[borough]] <- outliers_out$plot
        

        crimes <- replace_outliers(
            df_=crimes,
            y = y,
            outliers = outliers_out$outliers,
            level=borough
        )

    }

    if(y == "Shootings") {
        plot_in_grid(
            plot_list = outliers_plots,
            ncol = 2,
            title = paste(y, "outliers"),
        )
    }
    

}

crimes$TotArrests <- rowSums(crimes[, CRIME_NAMES], na.rm = TRUE)


```

Only two observations.
https://www.nytimes.com/2020/09/02/nyregion/nyc-shootings-murders.html

Here new data





### Larceny clusters

Isseu with Larceny that had a step time series and two clusters
```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "Larceny",
    y       = "Shootings",
    xlab    = "Larceny",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "Larceny in NYC over years",
    title_size = 16,
    jitter_ = TRUE,
    ticks   = 10,
    shape   = 19,
    size    = 2,
    colors  = unlist(PALETTE$boroughs)
)
```

Divide in two areas

```{r}

larceny_plots <- list()
for(level in levels(crimes$Borough)) {

    df_level <- crimes[crimes$Borough == level, ]
    df_level$Period <- as.factor(ifelse(
        df_level$Year %in% 2014:2019, "A", "B"
    ))

    larceny_plots[[level]] <- levels_scatterplot(
        df_     = df_level,
        x       = "Larceny",
        y       = "Shootings",
        xlab    = "Larceny",
        ylab    = "Shootings",
        levels  = "Period",
        title   = paste("Larceny - ", level),
        title_size = 12,
        jitter_ = TRUE,
        ticks   = 10,
        shape   = 19,
        size    = 1.5,
        colors  = c("#153283", "#ff7300"),
        legend = FALSE
    )
    
}

grid.arrange(
    grobs = larceny_plots,
    ncol = 2
)

rm(larceny_plots)

```

Problem for simpson paradox 

```{r}
df_level <- crimes[crimes$Borough == "Bronx", ]
df_level$Period <- as.factor(ifelse(
    df_level$Year %in% 2014:2019, "A", "B"
))

fit1 <- lm(Shootings ~ Larceny, data = df_level)
coefficients(fit1)

fit2 <- lm(Shootings ~ Larceny + Period, data = df_level)
coefficients(fit2)

grid.arrange(
    grobs = list(
        fit1 = plot_model_prediction(
            df_=df_level,
            model=fit1,
            points_size = 2,
            xlab = "Larceny arrests", ylab = "Shootings incidents",
            x="Larceny", y="Shootings"
        ),
        fit2 = plot_model_prediction_per_level(
            df_=df_level,
            model=fit2,
            x="Larceny", y="Shootings", levels="Period",
            points_size = 2,
            colors  = c("#153283", "#ff7300"),
            xlab = "Larceny arrests", ylab = "Shootings incidents",
            legend = FALSE
        )
    ),
    ncol = 2,
    top = grid::textGrob(
        "Larceny in NYC (Bronx) - Simpson Paradox", 
        gp = grid::gpar(fontsize = 16, fontface = "bold")
    )
)

rm(list = c("fit1", "fit2", "df_level"))


```

Difficult to treat, we probaly not use it becuase it needs for sophisticathed version.

### Crimes correlation

Investigate collinearity by fitting the full model.

See effects wich we expect to be positive

```{r}

full_model <- lm(
    Shootings ~ .,
    data = crimes[, c("Shootings", CRIME_NAMES)]
)

summary(full_model)

plot(allEffects(full_model))
```

Lot of negative, meaning that there'is collinearity.

We can also appreaciate problemsn with variability for some crimes, indicating the absence of datapoints for certain ranges of observations, (LicensingFirearm, Weapon Possession)

```{r}
vif_diagnostic(full_model) 

rm(full_model)
```

Strong avidence for certain predictors

We now all are positive correlated, negative correlation synyomatic of collinearity. 
Also VIF index says is. Dangerous for model fitting and automatic seleciton.

Let's better inspect if we can find family of crimes.

There is strong evidence. 

```{r}
plot_correlation_matrix(
    df = crimes[, c("Shootings", "TotArrests", CRIME_NAMES)],
    title = "NYC Crimes arrests correlation"
)
```

### Aggregating crime families

Plot scatterplots of involved ones.

```{r}
COLLINEAR <- c(
    "Assault", 
    "Mischief", 
    "MarijuanaPossession", 
    "Robbery", 
    "SubstancePossession",
    "WeaponPossession"
)

plot(crimes[, COLLINEAR])
```



#### Principal Component Analysis

Let's see PCA variablity for different boroughs.

```{r fig.width = 8, fig.height = 6}

pca_analysis(
    df_          = crimes,
    features     = c(CRIME_NAMES, "Shootings"),
    levels       = "Borough",
    individual   = FALSE,
    biplot_title = "PCA - Crimes in NYC",
    individuals  = "Boroughs - PCA",
    variables    = "Crimes - PCA",
)
```

Most of collnear in Brooklyn and Bronx

Assaults and Weapon possession along with shootings (and also mischief).

Marijuana and Substance Possession

Queens a part.


#### Domain knowledge

* **Assault** - An intentional act of causing physical injury to another person, including various degrees of assault such as third-degree assault, assault on a peace officer, and unclassified assault.

* **Burglary** - The unlawful entry into a building or residential or commercial area with the intent to commit a crime, including burglary in a residence at night, burglary in a commercial area during the day, and unclassified burglary.

* **Drug Paraphernalia** - The possession, sale, or distribution of tools used for the consumption, production, or sale of narcotics, including various degrees of possession and sale of such paraphernalia.

* **Larceny** - The unlawful taking of another person's property with the intent to permanently deprive the owner of their possessions, including petit larceny from open areas, grand larceny of auto, larceny by extortion, and theft of credit cards.

* **Licensing Firearm** - The possession, use, or distribution of firearms without the necessary license or in violation of firearm licensing laws, including criminal disposal of firearms.

* **Marijuana Possession** - The unlawful possession, sale, or distribution of marijuana, including various degrees of possession and sale of marijuana and the unlawful sale of synthetic marijuana.

* **Mischief** - The intentional destruction or damage to another person's property, including various degrees of criminal mischief, graffiti, damage to motor vehicles, and damage by fire or explosives.

* **Murder** - The intentional and unlawful killing of another person, including unclassified murder.

* **Robbery** - The use of force or threat of force to take property from another person, including robbery in open areas, carjacking, and robbery at gas stations.

* **Substance Possession** - The unlawful possession, sale, or distribution of controlled substances, including various degrees of possession, sale, and intent to sell controlled substances.

* **Theft** - The unlawful use of services without due payment, including theft of cable TV services and unclassified related offenses.

* **Weapon Possession** - The unlawful possession, use, or distribution of weapons, including various degrees of weapon possession, manufacturing and transportation of weapons, and prohibited use of weapons, including imitation pistols.


```{r}
CRIME_FAMILIES <- list(
    "Offense"  = c("Assault", "Mischief", "Robbery"),
    "DrugRelated"     = c("MarijuanaPossession", "SubstancePossession", "DrugParaphernalia"),
    "Drop"     = c("Larceny", "WeaponPossession")
)

CRIME_NAMES

```

```{r}

# crimes_old         <- crimes
# CRIME_NAMES_old <- CRIME_NAMES

crimes <- crimes_old
CRIME_NAMES <- CRIME_NAMES_old

for(fam_name in names(CRIME_FAMILIES)) {

    cols <- CRIME_FAMILIES[[fam_name]]

    if(length(cols) == 1) {
        crimes[[fam_name]] <- crimes[[cols[1]]]
    } else {
        crimes[[fam_name]] <- rowSums(crimes[, cols])
    }

    for (col in cols) {
        crimes[[col]] <- NULL
    }


    CRIME_NAMES <- c(CRIME_NAMES, fam_name)
    CRIME_NAMES <- CRIME_NAMES[!CRIME_NAMES %in% cols]
}

crimes$Drop <- NULL
CRIME_NAMES <- CRIME_NAMES[!CRIME_NAMES %in% "Drop"]
```

### Redo



```{r}


full_model <- lm(
    Shootings ~ .,
    data = crimes[, c("Shootings", CRIME_NAMES)]
)


vif_diagnostic(full_model) 

rm(full_model)

```

```{r}
plot_correlation_matrix(
    df = crimes[, c("Shootings", "TotArrests", CRIME_NAMES)],
    title = "NYC Crimes arrests correlation"
)
```

### Boroughs

Let's see the borough effect on the shootings.

```{r}

plot_boxplot(
    crimes, "Borough", "Shootings", "Shootings by Borough",
    colors = unlist(PALETTE$boroughs)
)
```

Clearly different crimilanilties

```{r}
crimes$Year <- as.factor(crimes$Year)
plot_boxplot(
    crimes, "Year", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('darkgreen', 'lightgreen'))(16)
)
crimes$Year <- as.numeric(crimes$Year) + 2005
```

There's a seasonal effect, also variability involved

```{r}
plot_boxplot(
    crimes, "MonthName", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('#c44e00', '#eebf82'))(12)
)

```

There's a slight trend

