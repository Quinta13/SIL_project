---
title: "NYC Shootings and Arrests - Data exploration"
author: "Sebastiano Quintavale - 878500"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        theme: cerulean
        highlight: tango
---

## 1. Introduction

This notebook is intended to ...

```{r echo=FALSE, include=FALSE}

# 1. RMardown styling
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(fig.width=9, fig.height=7)

# 2. Project environment setup
source("src/init.R")

```


### 1.1. Data preparation

Load the data and prepare it for the analysis.
```{r}

# Load data
crimes <- read.csv(PATHS$NycMonthCrimes)

```

The dataset has `r nrow(crimes)` rows and `r ncol(crimes)` columns.

View some rows and summary of the dataset as recap

```{r}

# Add discrete version for Month and Year
prepare_out <- prepare_crimes(crimes_df=crimes, use_families=FALSE)
crimes <- prepare_out$df

rm(prepare_out)

summary(crimes)
head(crimes, 25)

```

Brief comment on the type of the data.

### Train and Test split

We split train and test across years. Explain CV setup. Cannot apply cross validation for time dependence.
We only look at the train for exploration to simulate unseen data.
The dataset covers r`length(unique(crimes$Year))` years, we use the last r`length(YEAR_TEST)` for the test: r`YEAR_TEST`.

```{r}

# Split Train and Test
split <- train_test_split_by_year(
    df_=crimes, 
    year_test=YEAR_TEST
)

crimes      <- split$train
crimes_test <- split$test

rm(split)

```

Thus we have `r nrow(crimes)` for tran and `r nrow(crimes_test)` for test. 

## Visualizations

We start with brief visualization of the data to see if there are patterns in time and in the relationship between crimes and shootings.

### Time series

We start by plotting the time series of the crimes and shootings over the years.

```{r}

plot_multiple_ts(
    df_ts = ts_crimes_reshape(
        df_ = aggregate(
            . ~ Year + MonthName,
            data = crimes[, c("Year", "MonthName", CRIME_NAMES, "Shootings")], # Remove Borough, Month, TotArrests
            FUN = sum
        )
    ),
    group  = "CrimeType",
    xlab   = "Year",
    ylab   = "Incidents",
    title  = "Criminality in NYC - 2006 to 2021 ",
    lwd    = 0.6,
    ticks  = 7,
    colors = PALETTE$crimes
)

```


Different scale and trend.
We plot each individual and visualize the time series for each borough.

```{r fig.width=16, fig.height=12}

BOROUGH_LEGEND <- extract_legend(

    plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
            crime_type = "Shootings"
        ),
        group  = "Borough",
        xlab = "Year",
        ylab   = "Arrests",
        legend.direction = "horizontal",
        legend.size = 13,
        colors=unlist(PALETTE$boroughs)
    )

)

plot_in_grid <- function(plot_list, ncol = 1, title = "", title.size=15, height = 0.4) {

    to_plot <- c(plot_list, list(BOROUGH_LEGEND))

    nplots <- length(plot_list)
    nrow <- ceiling(nplots / ncol)

    # Create the layout matrix
    layout_matrix <- matrix(seq(1, nrow * ncol), nrow = nrow, ncol = ncol, byrow = TRUE)
    layout_matrix <- rbind(layout_matrix, rep(max(layout_matrix, na.rm = TRUE) + 1, ncol))


    return(grid.arrange(
        grobs = to_plot,
        ncol = ncol,
        top = textGrob(
            title, 
            gp = gpar(fontsize = title.size, fontface = "bold")),
            layout_matrix = layout_matrix,
            heights = c(rep(1, nrow), height)  # Adjust the relative height for the legend row
    ))

}

ts_plots <- list()

for (i in 1:length(CRIME_NAMES)) {

    crime_name <- CRIME_NAMES[i]

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        ylab   = ifelse((i-1) %% 5 == 0, "Arrests", ""),
        group  = "Borough",
        title  = paste(crime_name),
        lwd    = 0.6,
        colors = unlist(PALETTE$boroughs),
        ticks  = 3,
        legend = FALSE,
        title_size = 9
    )

}


plot_in_grid(
    plot_list = ts_plots,
    ncol = 5,
    title = "Crimes in NYC - 2006 to 2021"
)

rm(ts_plots)

```

Some comments patterns and variability

Let's see total number compared with the shootings.
```{r}

ts_plots <- list()

for (crime_name in c("TotArrests", "Shootings")) {

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        group  = "Borough",
        xlab   = "Year",
        ylab   = ifelse(crime_name=="TotArrests", "Total Arrests", "Shootings Incidents"),
        title  = paste(crime_name),
        lwd    = 0.6,
        colors = unlist(PALETTE$boroughs),
        ticks  = 5,
        legend = FALSE
    )

}

plot_in_grid(
    plot_list = ts_plots,
    ncol = 2,
    title = "Arrests and Shootings in NYC - 2006 to 2021",
    height = 0.1
)

rm(ts_plots)

```

Trend in TotArrests


### Scatterplots

See scatterplots of time variabiles. Year and Month.
```{r}

BOROUGH_LEGEND <- extract_legend(

    levels_scatterplot(
        df_     = crimes,
        x       = "Year",
        y       = "Shootings",
        levels  = "Borough",
        legend.direction = "horizontal",
        legend.size      = 15,
        colors = unlist(PALETTE$boroughs)
    )

)

scatterplots <- list()

# Plots
for (time in c("Year", "Month")) {
    scatterplots[[time]] <- levels_scatterplot(
        df_     = crimes,
        x       = time,
        y       = "Shootings",
        levels  = "Borough",
        title   = paste("Shootings by", time),
        title_size = 12,
        jitter_ = TRUE,
        ticks   = ifelse(time=="Month", 12, 5),
        shape   = 19,
        size    = 1,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE,
        ylab    = ifelse(time=="Year", "Shootings incidents", "")
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 2,
    title = "Shootings in NYC over time",
    title.size = 20,
    height = 0.1
)

rm(scatterplots)

```

Trend in the year with drop in 2020.
Seasonality with higher shootings in summer.

```{r}

scatterplots <- list()

# Plots
for (i in 1:length(CRIME_NAMES)) {

    crime <- CRIME_NAMES[i]

    scatterplots[[crime]] <- levels_scatterplot(
        df_     = crimes,
        x       = crime,
        y       = "Shootings",
        ylab    = ifelse((i-1) %% 5 == 0, "Shootings", ""),
        levels  = "Borough",
        title   = paste(crime),
        title_size = 9,
        jitter_ = TRUE,
        ticks   = 3,
        shape   = 20,
        size    = .05,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 5,
    title = "Crimes impact on shootings in NYC - 2006 to 2023"
)

rm(scatterplots)

```

```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "TotArrests",
    y       = "Shootings",
    xlab    = "Arrests",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "Total Arrests impact on  Shootings in NYC - 2016 to 2023",
    title_size = 14,
    jitter_ = TRUE,
    ticks   = 3,
    shape   = 19,
    size    = 1.5,
    colors  = unlist(PALETTE$boroughs)
)


```

Remarks:
Outliers
- StatenInsland very few crimes and shootings
- In general Bronx and Brooklyn tends to behave similar, and Queens and Manhattan tends to behave similar.
- There's a decrease to 2020 and then raise
- There seasonal effect at different scales
- Most linear evidence: Assaults, Murder, Robbery
- Possible Bi-cluster for larceny
- Marijuana sell possession it's interesting but has initial outliers.
- Quadratic effect for SubstancePossession, WeaponPossesion and TotArrests

## TODO Find name to this sections

### StatenInsland

Borough few criminalty treated differently from the others

```{r}

split_out <- split_statenisland(crimes=crimes, crimes_test=crimes_test)

crimes         <- split_out$crimes
crimes_test    <- split_out$crimes_test
si_crimes      <- split_out$si_crimes
si_crimes_test <- split_out$si_crimes_test

rm(split_out)

```


See info about Crimes

```{r}
summary(si_crimes)
```


```{r}

df_group_stats(si_crimes, "Year", "Shootings")

knit_table(t(df_group_stats(si_crimes, "Year", "Shootings")))
```

Month 
```{r}
knit_table(df_group_stats(si_crimes, "MonthName", "Shootings"))
```


### Outliers

Outliers substitution

Use tso 

```{r}
plot_multiple_ts(
    df_ts = ts_borough_reshape(
        df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
        crime_type = "Shootings"
    ),
    group = "Borough",
    xlab = "Year",
    ylab = "Incidents",
    title = paste("Shootings in NYC"),
    lwd = 0.7,
    colors = unlist(PALETTE$boroughs)
)
```

```{r}

palette_outlier <- PALETTE$outliers

plots <- list()

for(borough in levels(crimes$Borough)) {

    palette_outlier$ts <- PALETTE$boroughs[[borough]]

    outliers_out <- outliers_diagnostic(
        df_ = crimes[crimes$Borough == borough,],
        y = "Shootings",
        colors = palette_outlier,
        title = borough,
        ylab = "Shootings incidents"
    )

    plots[[borough]] <- outliers_out$plot
    

    crimes <- replace_outliers(
        df_=crimes,
        y = "Shootings",
        outliers = outliers_out$outliers,
        level=borough
    )

}

grid.arrange(grobs=plots, ncol=2)

rm(list=c("plots", "palette_outlier"))

```
https://www.nytimes.com/2020/09/02/nyregion/nyc-shootings-murders.html

Here new data
```{r}
plot_multiple_ts(
    df_ts = ts_borough_reshape(
        df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
        crime_type = "Shootings"
    ),
    group = "Borough",
    xlab = "Year",
    ylab = "Incidents",
    title = paste("Shootings in NYC"),
    lwd = 0.7,
    colors = unlist(PALETTE$boroughs)
)
```



### Larceny clusters


Isseu with Larceny that had a step time series and two clusters
```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "Larceny",
    y       = "Shootings",
    xlab    = "Larceny",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "Larceny in NYC over years",
    title_size = 16,
    jitter_ = TRUE,
    ticks   = 10,
    shape   = 19,
    size    = 1.5,
    colors  = unlist(PALETTE$boroughs)
)
```

Divide in two areas

```{r}

larceny_plots <- list()
for(level in levels(crimes$Borough)) {

    df_level <- crimes[crimes$Borough == level, ]
    df_level$Period <- as.factor(ifelse(
        df_level$Year %in% 2014:2019, "A", "B"
    ))

    larceny_plots[[level]] <- levels_scatterplot(
        df_     = df_level,
        x       = "Larceny",
        y       = "Shootings",
        xlab    = "Larceny",
        ylab    = "Shootings",
        levels  = "Period",
        title   = paste("Larceny - ", level),
        title_size = 12,
        jitter_ = TRUE,
        ticks   = 10,
        shape   = 19,
        size    = 1.5,
        colors  = c("#153283", "#ff7300"),
        legend = FALSE
    )
    
}

grid.arrange(
    grobs = larceny_plots,
    ncol = 2
)

rm(larceny_plots)

```

Problem for simpson paradox 

```{r}
df_level <- crimes[crimes$Borough == "Bronx", ]
df_level$Period <- as.factor(ifelse(
    df_level$Year %in% 2014:2019, "A", "B"
))

fit_1 <- lm(Shootings ~ Larceny, data = df_level)
coefficients(fit_1)

fit_2 <- lm(Shootings ~ Larceny + Period, data = df_level)
coefficients(fit_2)

grid.arrange(
    grobs = list(
        fit1 = plot_model_prediction(
            df_=df_level,
            model=fit_1,
            points_size = 2,
            xlab = "Larceny arrests", ylab = "Shootings incidents",
            x="Larceny", y="Shootings"
        ),
        fit2 = plot_model_prediction_per_level(
            df_=df_level,
            model=fit_2,
            x="Larceny", y="Shootings", levels="Period",
            points_size = 2,
            colors  = c("#153283", "#ff7300"),
            xlab = "Larceny arrests", ylab = "Shootings incidents",
            legend = FALSE
        )
    ),
    ncol = 2,
    top = grid::textGrob(
        "Larceny in NYC (Bronx) - Simpson Paradox", 
        gp = grid::gpar(fontsize = 16, fontface = "bold")
    )
)

rm(list = c("fit1", "fit2", "df_level"))


```

Difficult to treat, we probaly not use it becuase it needs for sophisticathed version.

### Crimes correlation

Investigate collinearity by fitting the full model.

See effects wich we expect to be positive

```{r}

full_model <- lm(
    Shootings ~ .,
    data = crimes[, c("Shootings", CRIME_NAMES)]
)

summary(full_model)

plot(allEffects(full_model))
```

Lot of negative, meaning that there'is collinearity.

```{r}
vif_diagnostic(full_model) 

rm(full_model)
```



We now all are positive correlated, negative correlation synyomatic of collinearity. 
Also VIF index says is. Dangerous for model fitting and automatic seleciton.

Let's better inspect if we can find family of crimes.

There is strong evidence. 

```{r}
plot_correlation_matrix(
    df = crimes[, c("Shootings", "TotArrests", CRIME_NAMES)],
    title = "NYC Crimes arrests correlation"
)
```

### Crimes Scatterplots

```{r}
# plot(crimes[, CRIME_NAMES])
```


### PCA Biplot

We need to see if we can manage to aggregate some crime in a family. Let's see if the biplot can help


### Principal Component Analysis

Let's see PCA variablity for different boroughs.

```{r fig.width = 8, fig.height = 6}

pca_analysis(
    df_          = crimes,
    features     = c(CRIME_NAMES, "Shootings"),
    levels       = "Borough",
    biplot_title = "PCA - Crimes in NYC",
    individuals  = "Boroughs - PCA",
    variables    = "Crimes - PCA",
)
```

Larceny and Forgery - Burglary and Bribery - Robbery, DruguParahenalia

Queens
```{r}

pca_analysis(
    df_       = crimes[crimes$Borough != "Queens", ],
    features  = c(CRIME_NAMES, "Shootings"),
    levels    = "Borough",
    biplot_title     = "PCA - Crimes in NYC",
    explained = FALSE, individual_vars = FALSE
)

```


3 possession
Bribery and Burglary
MIschief and DrugParaphernalia

### Crimes Descriptions

**Assault** - The act of inflicting physical harm or unwanted physical contact upon a person. (*it* Aggressione)

**Burglary** - Unlawful entry into a building or structure with the intent to commit a crime, usually theft. (*it* Furto con scasso)

**Drug Paraphernalia** - Equipment, products, and materials used or intended for use in producing, concealing, or consuming illegal drugs. (*it* Paraphernalia per droghe)

**Firearm** - The illicit production of firearms. (*it* Produzione illecita di armi)

**Forgery** - The act of falsifying documents, signatures, or other items with the intent to deceive or defraud. (*it* Falsificazione)

**Larceny** - The unlawful taking and carrying away of someone else's personal property with the intent to permanently deprive the owner of its possession. (*it* Approprazione di proprietÃ )

**Mischief** - Willful damage or destruction of property, also known as vandalism. (*it* Danneggiamento)

**Marijuana Sell/Possession** - The act of selling or possessing marijuana, which is illegal under certain jurisdictions. (*it* Vendita/Possesso di marijuana)

**Murder** - The unlawful premeditated killing of one human being by another. (*it* Omicidio)

**Robbery** - The taking of property from a person by force or intimidation. (*it* Rapina)

**Substance Possession** - The act of having control over a controlled substance without legal authorization. (*it* Possesso di sostanze)

**Theft** - The act of taking someone else's property with the intent to permanently deprive them of it. (*it* Furto)

**Trespass** - The act of unlawfully entering or remaining on someone else's property. (*it* Violazione di domicilio)

**Weapons Possession** - The act of owning, carrying, or controlling a weapon, typically illegal in certain contexts. (*it* Possesso di armi)

```{r}
CRIME_FAMILIES <- list(
    "IllegalPossesion" = c("MarijuanaPossession", "SubstancePossession", "WeaponPossession"),
    "AgainstProperty"  = c("Robbery", "Theft", "Trespass"),
    "Offense"          = c("Assault", "Mischief"),
    "Drop"             = c("Larceny")
)

```

```{r}

for(fam_name in names(CRIME_FAMILIES)) {

    print(fam_name)

    cols <- CRIME_FAMILIES[[fam_name]]

    if(length(cols) == 1) {
        crimes[[fam_name]] <- crimes[[cols[1]]]
    } else {
        crimes[[fam_name]] <- rowSums(crimes[, cols])
    }

    for (col in cols) {
        crimes[[col]] <- NULL
    }


    CRIME_NAMES <- c(CRIME_NAMES, fam_name)
    CRIME_NAMES <- CRIME_NAMES[!CRIME_NAMES %in% cols]
}

crimes$Drop <- NULL
CRIME_NAMES <- CRIME_NAMES[!CRIME_NAMES %in% "Drop"]
```

### Redo

```{r}

full_model <- lm(
    Shootings ~ .,
    data = crimes[, c("Shootings", CRIME_NAMES)]
)

plot(allEffects(full_model))

```

Lot of negative, meaning that there'is collinearity.

```{r}
vif_diagnostic(full_model) 
```

```{r}
plot_correlation_matrix(
    df = crimes[, c("Shootings", "TotArrests", CRIME_NAMES)],
    title = "NYC Crimes arrests correlation"
)
```

### Boroughs

Let's see the borough effect on the shootings.

```{r}

plot_boxplot(
    crimes, "Borough", "Shootings", "Shootings by Borough",
    colors = unlist(PALETTE$boroughs)
)
```

Clearly different crimilanilties

```{r}
crimes$Year <- as.factor(crimes$Year)
plot_boxplot(
    crimes, "Year", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('darkgreen', 'lightgreen'))(16)
)
crimes$Year <- as.numeric(crimes$Year) + 2005
```

There's a seasonal effect, also variability involved

```{r}
plot_boxplot(
    crimes, "MonthName", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('#c44e00', '#eebf82'))(12)
)

```

There's a slight trend

