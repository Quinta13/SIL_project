---
title: "NYC Shootings and Arrests - Data exploration"
author: "Sebastiano Quintavale - 878500"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    html_document:
        toc: true
        toc_float: true
        theme: cerulean
        highlight: tango
---

## Introduction

```{r echo=FALSE, include=FALSE}

# 1. RMardown styling
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)

# 2. Project environment setup
source("src/init.R")

```


### Data preparation

Load the data and prepare it for the analysis.
```{r}

# Load data
crimes <- read.csv(PATHS$NycMonthCrimes)

CRIME_NAMES <- c(CRIME_NAMES, "MarijuanaSellPossession")

```

The dataset has `r nrow(crimes)` rows and `r ncol(crimes)` columns.


View some rows and summary of the dataset.

```{r}

# Add discrete version for Month and Year
crimes <- prepare_crimes(crimes_df=crimes, col_merge=FALSE)

summary(crimes)
head(crimes)

```

### Train and Test split

We split train and test across years. 
Cannot apply cross validation for time dependence.
The dataset covers r`length(unique(crimes$Year))` years, we use the last r`length(YEAR_TEST)` for the test: r`YEAR_TEST`.

```{r}

# Split Train and Test
split <- train_test_split_by_year(
    df_=crimes, 
    year_test=YEAR_TEST
)

crimes      <- split$train
crimes_test <- split$test

rm(split)

```

## Visualizations

### Time series

We start by plotting the time series of the crimes and shootings over the years.

```{r}

plot_multiple_ts(
    df_ts = ts_crimes_reshape(
        df_ = aggregate(
            . ~ Year + MonthName,
            data = crimes[, c("Year", "MonthName", CRIME_NAMES, "Shootings")], # Remove Borough, Month, TotArrests
            FUN = sum
        )
    ),
    group  = "CrimeType",
    xlab   = "Year",
    ylab   = "Incidents",
    title  = "Criminality in NYC - 2006 to 2021 ",
    lwd    = 0.6,
    ticks  = 7,
    colors = PALETTE$crimes
)

```

We better visualize the time series for each borough.


```{r fig.width=16, fig.height=12}

BOROUGH_LEGEND <- extract_legend(

    plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
            crime_type = "Shootings"
        ),
        group  = "Borough",
        xlab = "Year",
        ylab   = "Arrests",
        legend.direction = "horizontal",
        colors=unlist(PALETTE$boroughs)
    )

)

plot_in_grid <- function(plot_list, ncol = 1, title = "") {

    to_plot <- c(plot_list, list(BOROUGH_LEGEND))

    nplots <- length(plot_list)
    nrow <- ceiling(nplots / ncol)

    # Create the layout matrix
    layout_matrix <- matrix(seq(1, nrow * ncol), nrow = nrow, ncol = ncol, byrow = TRUE)
    layout_matrix <- rbind(layout_matrix, rep(max(layout_matrix, na.rm = TRUE) + 1, ncol))


    return(grid.arrange(
        grobs = to_plot,
        ncol = ncol,
        top = textGrob(
            title, 
            gp = gpar(fontsize = 15, fontface = "bold")),
            layout_matrix = layout_matrix,
            heights = c(rep(1, nrow), 0.2)  # Adjust the relative height for the legend row
    ))

}

ts_plots <- list()

for (i in 1:length(CRIME_NAMES)) {

    crime_name <- CRIME_NAMES[i]

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        ylab   = ifelse((i-1) %% 5 == 0, "Arrests", ""),
        group  = "Borough",
        title  = paste(crime_name),
        lwd    = 0.6,
        colors = unlist(PALETTE$boroughs),
        ticks  = 3,
        legend = FALSE,
        title_size = 9
    )

}


plot_in_grid(
    plot_list = ts_plots,
    ncol = 5,
    title = "Crimes in NYC - 2006 to 2021"
)

rm(ts_plots)

```

Some comments

Let's see total number compared with the shootings.
```{r}

ts_plots <- list()

for (crime_name in c("TotArrests", "Shootings")) {

    ts_plots[[crime_name]] <- plot_multiple_ts(
        df_ts = ts_borough_reshape(
            df_ = crimes[, c("Borough", "Year", "MonthName", crime_name)],
            crime_type = crime_name
        ),
        group  = "Borough",
        xlab   = "Year",
        ylab   = ifelse(crime_name=="TotArrests", "Arrests", "Shootings"),
        title  = paste(crime_name),
        lwd    = 0.6,
        colors = unlist(PALETTE$boroughs),
        ticks  = 5,
        legend = FALSE
    )

}

plot_in_grid(
    plot_list = ts_plots,
    ncol = 2,
    title = "Arrests and Shootings in NYC - 2006 to 2021"
)

rm(ts_plots)

```



### Principal Component Analysis

Let's see PCA variablity for different boroughs.

```{r fig.width = 8, fig.height = 6}

pca_analysis(
    df_          = crimes,
    features     = c(CRIME_NAMES, "Shootings"),
    levels       = "Borough",
    biplot_title = "PCA - Crimes in NYC",
    individuals  = "Boroughs - PCA",
    variables    = "Crimes - PCA",
)
```

StatnIsland not crime area.
```{r}

pca_analysis(
    df_       = crimes[crimes$Borough != "StatenIsland", ],
    features  = c(CRIME_NAMES, "Shootings"),
    levels    = "Borough",
    biplot_title     = "PCA - Crimes in NYC",
    explained = FALSE, individual_vars = FALSE
)
```

Quuens really few variability

```{r}
pca_analysis(
    df_       = crimes[!(crimes$Borough %in% c("Queens", "StatenIsland")), ],
    features  = c(CRIME_NAMES, "Shootings"),
    levels    = "Borough",
    biplot_title     = "PCA - Crimes in NYC",
    explained = FALSE, individual_vars = FALSE
)
```

Most in Brooklyn and Bronx. We see shootings same variability of Assaults and Shootings.

See the opposite view.
```{r}
crimes_v2 <- crimes[, -c(19, 22)] %>% # Remove TotArrests and SqrtTotArrests
    pivot_longer(
        cols = -(c(Borough, Year, Month, MonthName)),
        names_to = "CrimeType",
        values_to = "Count"
    ) %>%
    pivot_wider(
        names_from = Borough,
        values_from = Count
    )
crimes_v2$CrimeType <- as.factor(crimes_v2$CrimeType)

pca_analysis(
    df_       = crimes_v2,
    features  = levels(crimes$Borough),
    levels       = "CrimeType",
    biplot_title = "PCA - Crimes in NYC",
    individuals  = "Crimes - PCA",
    variables    = "Borough - PCA",
)

rm(crimes_v2)

```

### Scatterplots

See scatterplots of time variabiles. Year and Month.
```{r}

BOROUGH_LEGEND <- extract_legend(

    levels_scatterplot(
        df_     = crimes,
        x       = "Year",
        y       = "Shootings",
        levels  = "Borough",
        legend.direction = "horizontal",
        colors = unlist(PALETTE$boroughs)
    )

)

scatterplots <- list()

# Plots
for (time in c("Year", "Month")) {
    scatterplots[[time]] <- levels_scatterplot(
        df_     = crimes,
        x       = time,
        y       = "Shootings",
        levels  = "Borough",
        title   = paste("Shootings by", time),
        jitter_ = TRUE,
        ticks   = ifelse(time=="Month", 12, 5),
        shape   = 19,
        size    = 1,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE,
        ylab    = ifelse(time=="Year", "Shootings incidents", "")
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 2,
    title = "Shootings in NYC over time"
)

rm(scatterplots)

```

Trend in the year with drop in 2020.
Seasonality with higher shootings in summer.

```{r}

scatterplots <- list()

# Plots
for (i in 1:length(CRIME_NAMES)) {

    crime <- CRIME_NAMES[i]

    scatterplots[[crime]] <- levels_scatterplot(
        df_     = crimes,
        x       = crime,
        y       = "Shootings",
        ylab    = ifelse((i-1) %% 5 == 0, "Shootings", ""),
        levels  = "Borough",
        title   = paste(crime),
        title_size = 9,
        jitter_ = TRUE,
        ticks   = 3,
        shape   = 1,
        size    = .5,
        colors  = unlist(PALETTE$boroughs),
        legend  = FALSE
    )
}

plot_in_grid(
    plot_list = scatterplots,
    ncol = 5,
    title = "Crimes impact on shootings in NYC - 2006 to 2023"
)

rm(scatterplots)

```

```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "TotArrests",
    y       = "Shootings",
    xlab    = "Arrests",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "Total Arrests impact on  Shootings in NYC - 2016 to 2023",
    title_size = 14,
    jitter_ = TRUE,
    ticks   = 3,
    shape   = 19,
    size    = 1.5,
    colors  = unlist(PALETTE$boroughs)
)


```

Remarks:

- StatenInsland very few crimes and shootings
- In general Bronx and Brooklyn tends to behave similar, and Queens and Manhattan tends to behave similar.
- There's a decrease to 2020 and then raise
- There seasonal effect at different scales
- Most linear evidence: Assaults, Murder, Robbery
- Possible Bi-cluster for larceny
- Marijuana sell possession it's interesting but has initial outliers.
- Quadratic effect for SubstancePossession, WeaponPossesion and TotArrests

### Outliers

Outliers substitution

Use tso 


```{r}
plot_multiple_ts(
    df_ts = ts_borough_reshape(
        df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
        crime_type = "Shootings"
    ),
    group = "Borough",
    xlab = "Year",
    ylab = "Incidents",
    title = paste("Shootings in NYC"),
    lwd = 0.7,
    colors = unlist(PALETTE$boroughs)
)

palette_outlier <- PALETTE$outliers

plots <- list()

for(borough in levels(crimes$Borough)) {

    palette_outlier$ts <- PALETTE$boroughs[[borough]]

    outliers_out <- outliers_diagnostic(
        df_ = crimes[crimes$Borough == borough,],
        y = "Shootings",
        colors = palette_outlier,
        title = borough,
        ylab = "Shootings incidents"
    )

    plots[[borough]] <- outliers_out$plot
    

    crimes <- replace_outliers(
        df_=crimes,
        y = "Shootings",
        outliers = outliers_out$outliers,
        level=borough
    )

}

grid.arrange(grobs=plots, ncol=2)

rm(list=c("plots", "palette_outlier"))

```
https://www.nytimes.com/2020/09/02/nyregion/nyc-shootings-murders.html

Here new data
```{r}
plot_multiple_ts(
    df_ts = ts_borough_reshape(
        df_ = crimes[, c("Borough", "Year", "MonthName", "Shootings")],
        crime_type = "Shootings"
    ),
    group = "Borough",
    xlab = "Year",
    ylab = "Incidents",
    title = paste("Shootings in NYC"),
    lwd = 0.7,
    colors = unlist(PALETTE$boroughs)
)
```



### Larceny clusters


Isseu with Larceny that had a step time series and two clusters
```{r}

levels_scatterplot(
    df_     = crimes,
    x       = "Larceny",
    y       = "Shootings",
    xlab    = "Larceny",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "Larceny in NYC over years",
    title_size = 16,
    jitter_ = TRUE,
    ticks   = 10,
    shape   = 19,
    size    = 1.5,
    colors  = unlist(PALETTE$boroughs)
)
```

Divide in two areas

```{r}

larceny_plots <- list()
for(level in levels(crimes$Borough)) {

    df_level <- crimes[crimes$Borough == level, ]
    df_level$Period <- as.factor(ifelse(
        df_level$Year %in% 2014:2019, "A", "B"
    ))

    larceny_plots[[level]] <- levels_scatterplot(
        df_     = df_level,
        x       = "Larceny",
        y       = "Shootings",
        xlab    = "Larceny",
        ylab    = "Shootings",
        levels  = "Period",
        title   = paste("Larceny - ", level),
        title_size = 12,
        jitter_ = TRUE,
        ticks   = 10,
        shape   = 19,
        size    = 1.5,
        colors  = c("blue", "orange"),
        legend = FALSE
    )
    
}

grid.arrange(
    grobs = larceny_plots,
    ncol = 2
)

rm(larceny_plots)

```

Problem for simpson paradox 

```{r}
df_level <- crimes[crimes$Borough == "Bronx", ]
df_level$Period <- as.factor(ifelse(
    df_level$Year %in% 2014:2019, "A", "B"
))

fit_1 <- lm(Shootings ~ Larceny, data = df_level)
coefficients(fit_1)

fit_2 <- lm(Shootings ~ Larceny + Period, data = df_level)
coefficients(fit_2)

grid.arrange(
    grobs = list(
        fit1 = plot_model_prediction(
            df_=df_level,
            model=fit_1,
            points_size = 2,
            xlab = "Larceny arrests", ylab = "Shootings incidents",
            x="Larceny", y="Shootings"
        ),
        fit2 = plot_model_prediction_per_level(
            df_=df_level,
            model=fit_2,
            x="Larceny", y="Shootings", levels="Period",
            points_size = 2,
            colors  = c("blue", "orange"),
            xlab = "Larceny arrests", ylab = "Shootings incidents"
        )
    ),
    ncol = 2,
    top = grid::textGrob(
        "Larceny in NYC (Bronx) - Simpson Paradox", 
        gp = grid::gpar(fontsize = 16, fontface = "bold")
    )
)

rm(list = c("fit1", "fit2", "df_level"))


```



### Marijuana zero arrests

```{r}

plot_in_grid(
    plot_list = list(
    marijuana = levels_scatterplot(
        df_     = crimes,
        x       = "MarijuanaSellPossession",
        y       = "Shootings",
        xlab    = "Arrests",
        ylab    = "MarijuanaSellPossession",
        levels  = "Borough",
        title   = "MarijuanaSellPossession in NYC over years",
        title_size = 12,
        jitter_ = TRUE,
        ticks   = 10,
        shape   = 19,
        size    = 1.5,
        legend  = FALSE,
        colors  = unlist(PALETTE$boroughs)
    ),
    substance = levels_scatterplot(
        df_     = crimes,
        x       = "SubstancePossession",
        y       = "Shootings",
        xlab    = "Arrests",
        ylab    = "SubstancePossession",
        levels  = "Borough",
        title   = "SubstancePossession in NYC over years",
        title_size = 12,
        jitter_ = TRUE,
        ticks   = 10,
        shape   = 19,
        size    = 1.5,
        legend  = FALSE,
        colors  = unlist(PALETTE$boroughs)
    )
),
    ncol = 2,
    title = ""
)

summary(as.factor(crimes[
    crimes$MarijuanaSellPossession == 0, 
]$Year))

```

Problem with marijuana with zero arrests (not that there is jitter in the plot)

```{r}
# Create a new column that is the sum of MarijuanaSellPOssesion and SubstancePossession
crimes$SubstanceAndMarijuanaPossession <- crimes$SubstancePossession + crimes$MarijuanaSellPossession

levels_scatterplot(
    df_     = crimes,
    x       = "SubstanceAndMarijuanaPossession",
    y       = "Shootings",
    xlab    = "Arrests",
    ylab    = "Shootings",
    levels  = "Borough",
    title   = "SubstanceAndMarijuanaPossession in NYC over years",
    title_size = 12,
    jitter_ = TRUE,
    ticks   = 10,
    shape   = 19,
    size    = 1.5,
    legend  = FALSE,
    colors  = unlist(PALETTE$boroughs)
)

crimes[
    crimes$SubstanceAndMarijuanaPossession <500 &
    crimes$Shootings > 50, 
    c("Borough", "Year", "SubstancePossession", "MarijuanaSellPossession", "Shootings")
]

```

Seem no record of marijuana after 2021

### Crimes correlation

Investigate collinearity by fitting the full model.

```{r}

full_model <- lm(
    Shootings ~ .,
    data = crimes[, c("Shootings", CRIME_NAMES)]
)

summary(full_model)

plot(allEffects(full_model))

vif_diagnostic(full_model) 

rm(full_model)

```

We now all are positive correlated, negative correlation synyomatic of collinearity. 
Also VIF index says is.


There is strong evidence. 

```{r}
plot_correlation_matrix(
    df = crimes[, c("Shootings", "TotArrests", CRIME_NAMES)],
    title = "NYC Crimes arrests correlation"
)
```



### Boroughs

Let's see the borough effect on the shootings.

```{r}

plot_boxplot(
    crimes, "Borough", "Shootings", "Shootings by Borough",
    colors = unlist(PALETTE$boroughs)
)
```

Clearly different crimilanilties

```{r}
crimes$Year <- as.factor(crimes$Year)
plot_boxplot(
    crimes, "Year", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('darkgreen', 'lightgreen'))(16)
)
crimes$Year <- as.numeric(crimes$Year) + 2005
```

There's a seasonal effect, also variability involved

```{r}
plot_boxplot(
    crimes, "MonthName", "Shootings", "Shootings by Year",
    colors = colorRampPalette(c('#c44e00', '#eebf82'))(12)
)

```

There's a slight trend

### Previous month

```{r}
# Specify the columns to shift
shift_cols <- c("Shootings", "TotArrests", CRIME_NAMES)

crimes_shifted <- crimes

# Loop through each column and create a new shifted column
for (col in shift_cols) {
    crimes_shifted[[paste("Prev", col, sep="")]] <- c(NA, crimes_shifted[[col]][-length(crimes_shifted[[col]])])
}

# Remove the first date
crimes_df <- crimes_shifted[
    !(crimes_shifted$Year == 2006 & crimes_shifted$Month == 1), 
]

prev_cols <- sapply(shift_cols, function(col) paste("Prev", col, sep=""))

correlation <- cor(crimes_df[, shift_cols], use = "pairwise.complete.obs")

prev_cols2 <- c("Shootings", prev_cols[prev_cols != "PrevShootings"])
correlation2 <- cor(crimes_df[, prev_cols2], use = "pairwise.complete.obs")
head(crimes_df)

# time_corr <- data.frame(
#     Previous = correlation2[1, -1],
#     Current  = correlation [1, -1]
# )
# rownames(time_corr) <- rownames(correlation)[-1]
# time_corr$Direction <- ifelse(time_corr$Previous > time_corr$Current, "<-", "->")
# 
# time_corr


```